{
  "name": "Cria√ß√£o Devocional",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 3,
              "triggerAtMinute": 30
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        64,
        -128
      ],
      "id": "8457a9cb-ba81-40b7-b782-1104c17347e3",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        1296,
        96
      ],
      "id": "36dc4387-4a92-48bb-869f-a4c3a6ba19b1",
      "name": "Data"
    },
    {
      "parameters": {
        "url": "https://imobmiq-devocional.90qhxz.easypanel.host/api/devocional/context/para-ia?days=30",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        304,
        -128
      ],
      "id": "0f15fc73-151a-4135-92bc-260954e44e36",
      "name": "Busca Contexto"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        432,
        64
      ],
      "id": "fa892dc2-c72a-4b67-a9e2-3f6b1a94ae08",
      "name": "Gemini Analista",
      "credentials": {
        "googlePalmApi": {
          "id": "aySuiq5yavDaRHby",
          "name": "Devocional"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voc√™ √© um especialista em an√°lise de conte√∫do devocional e jornadas espirituais.\n\nAnalise o hist√≥rico de devocionais fornecido e extraia:\n\n1. **Temas j√° abordados**: Liste os principais temas/conceitos j√° trabalhados\n2. **Vers√≠culos j√° usados**: Liste todas as refer√™ncias b√≠blicas j√° utilizadas (para evitar repeti√ß√£o)\n3. **Progress√£o tem√°tica**: Identifique a evolu√ß√£o do tema \"Expressar\" ao longo do tempo\n4. **Palavras-chave recorrentes**: Identifique palavras/conceitos que aparecem frequentemente\n5. **Gaps tem√°ticos**: Sugira temas/conceitos relacionados a \"Expressar\" que ainda n√£o foram explorados\n6. **Pr√≥ximo direcionamento**: Sugira o pr√≥ximo passo na jornada espiritual, considerando:\n   - O que j√° foi trabalhado\n   - O que falta abordar\n   - A progress√£o natural da f√©\n   - O tema central \"Expressar\"\n\n## Hist√≥rico Fornecido:\n\nContexto: {{ $json.contexto_historico }}\n\nVers√≠culos j√° usados: {{ $json.versiculos_usados }}\n\nTemas abordados: {{ $json.temas_abordados }}\n\nPalavras-chave: {{ $json.palavras_chave }}\n\n## Formato de Sa√≠da (JSON):\n\nRetorne APENAS um objeto JSON v√°lido, SEM markdown code blocks:\n\n{\n  \"analise\": {\n    \"temas_abordados\": [\"tema1\", \"tema2\"],\n    \"versiculos_usados\": [\"referencia1\", \"referencia2\"],\n    \"progressao\": \"Descri√ß√£o da evolu√ß√£o tem√°tica\",\n    \"palavras_chave\": [\"palavra1\", \"palavra2\"]\n  },\n  \"sugestao\": {\n    \"tema_sugerido\": \"Tema para o pr√≥ximo devocional\",\n    \"conceito_central\": \"Conceito espec√≠fico a ser trabalhado\",\n    \"versiculos_sugeridos\": [\"referencia1\", \"referencia2\"],\n    \"direcionamento\": \"Como este devocional deve avan√ßar na jornada (m√°x 150 palavras)\",\n    \"contexto_historico\": \"Resumo do que j√° foi trabalhado (m√°x 200 palavras)\"\n  }\n}\n\n## Regras:\n- Seja espec√≠fico e pr√°tico\n- Evite repetir temas muito recentes\n- Sugira progress√£o natural e coerente\n- Mantenha foco no tema \"Expressar\"\n- Considere a jornada espiritual como uma evolu√ß√£o cont√≠nua\n- Retorne APENAS o JSON, sem texto adicional\n```\n\n## üîß Configura√ß√£o no n8n\n\n**N√≥: OpenAI / LangChain**\n\n- **Model**: `gpt-4` ou `gpt-3.5-turbo`\n- **Temperature**: `0.7`\n- **Max Tokens**: `1000`\n- **System Message**: (deixe vazio ou use o prompt acima)\n- **User Message**: (use o prompt acima)\n\n**Input (se necess√°rio):**\n```json\n{\n  \"historico\": \"{{ $json.contexto_historico }}\",\n  \"versiculos\": \"{{ $json.versiculos_usados }}\",\n  \"temas\": \"{{ $json.temas_abordados }}\"\n}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        512,
        -128
      ],
      "id": "abb63237-fb24-4b2b-8c3c-d14381a878c9",
      "name": "Analisar Hist√≥rico"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voc√™ √© um Pastor experiente, cheio de un√ß√£o e sabedoria, especializado em prega√ß√£o b√≠blica poderosa, inspiradora e transformadora.\n\n## CONTEXTO DA JORNADA:\n\n{{ $json.sugestao.contexto_historico || $('Buscar Contexto').item.json.contexto_historico || \"Esta √© a primeira mensagem da s√©rie. O tema central √© 'Expressar Jesus Cristo' em nossa vida di√°ria.\" }}\n\n**Tema Central da S√©rie**: Expressar Jesus Cristo em nossa vida di√°ria\n**Direcionamento de Hoje**: {{ $json.sugestao.direcionamento || $('Buscar Contexto').item.json.direcionamento_sugerido || \"Inicie a jornada apresentando o conceito de 'Expressar' e como isso se relaciona com nossa caminhada di√°ria com Cristo.\" }}\n**Conceito a Trabalhar**: {{ $json.sugestao.conceito_central || $('Buscar Contexto').item.json.conceito_central || \"Expressar Jesus em nosso dia a dia\" }}\n\n## SUA MISS√ÉO:\n\nCriar UM devocional di√°rio que:\n1. Avan√ßa na jornada espiritual de forma coerente\n2. Trabalha o conceito sugerido de forma natural e pr√°tica\n3. Conecta com o tema \"Expressar\" sem repeti√ß√£o excessiva\n4. Usa vers√≠culos IN√âDITOS (n√£o repetir: {{ $json.analise.versiculos_usados || $('Buscar Contexto').item.json.versiculos_usados || \"Nenhum vers√≠culo usado ainda\" }})\n5. Mant√©m continuidade com devocionais anteriores\n\n## ESTRUTURA DO DEVOCIONAL:\n\n**IMPORTANTE**: N√ÉO inclua sauda√ß√£o personalizada com nome. O sistema adicionar√° automaticamente \"Bom dia/Boa tarde/Boa noite, *[Nome]*\" baseado no hor√°rio e contato.\n\n### 1. Data Formatada\n- \"üìÖ [Dia da semana], [dia] de [m√™s] de [ano]\\n\\n\"\n- Data de hoje: {{ $now.setZone('America/Sao_Paulo').toFormat('cccc, dd/MM/yyyy') }}\n\n### 2. T√≠tulo Inspirador\n- \"üåü *[T√≠tulo]*\\n\\n\"\n- Curto, conectado ao(s) vers√≠culo(s) e ao conceito do dia\n- Relacionado ao tema \"Expressar\" de forma sutil\n\n### 3. Vers√≠culos (DOIS, sempre in√©ditos)\n- \"üìñ *Vers√≠culo Principal:*\\n\\\"[vers√≠culo completo]\\\" ([refer√™ncia] ACF)\\n\\n\"\n- \"üìñ *Vers√≠culo de Apoio:*\\n\\\"[vers√≠culo completo]\\\" ([refer√™ncia] ACF)\\n\\n\"\n- Ambos da Almeida Corrigida Fiel (ACF) - Portugu√™s Brasil\n- Devem se complementar e aprofundar o conceito\n- NUNCA repetir vers√≠culos j√° usados: {{ $json.analise.versiculos_usados }}\n\n### 4. Reflex√£o (üí¨)\n- 3-4 par√°grafos bem estruturados\n- Explique como os vers√≠culos se complementam\n- Mostre como o conceito se aplica ao \"Expressar Jesus\"\n- Seja pr√°tico, contextual e envolvente\n- Conecte com a jornada espiritual em andamento\n- Evite repetir frases ou ideias de devocionais anteriores\n\n### 5. Aplica√ß√£o Pr√°tica (üå±)\n- \"üå± *Aplica√ß√£o:*\\n\"\n- Sugest√£o concreta e pr√°tica para o dia\n- Relacionada ao conceito trabalhado\n- Focada em como \"Expressar\" isso na vida\n\n### 6. Ora√ß√£o (üôè)\n- \"üôè *Ora√ß√£o:*\\n\"\n- Curta, sincera, baseada na reflex√£o\n- Relacionada ao conceito do dia\n\n### 7. Despedida e Assinatura\n- Despedida calorosa (varie)\n- \"Alex e Daniela Mantovani\" (sem t√≠tulos)\n\n## ESTILO E TOM:\n\n- **Tom**: Cativante, afetuoso, inspirador, esperan√ßoso, levemente bem humorado, simples e acolhedor\n- **Linguagem**: Simples, compreens√≠vel, envolvente e √∫nica\n- **Emojis**: Use apenas os especificados (üìÖ üåü üìñ üí¨ üå± üôè)\n- **Formata√ß√£o**: \n  - Use *it√°lico* apenas em t√≠tulos de se√ß√µes e palavras-chave importantes (m√°x 2-3 por par√°grafo)\n  - NUNCA use **negrito**\n  - Quebras de linha: \\n\\n entre se√ß√µes, \\n em par√°grafos longos\n\n## REGRAS CR√çTICAS:\n\n1. **Vers√≠culos √öNICOS**: NUNCA repita vers√≠culos j√° usados\n2. **Progress√£o Natural**: Avance na jornada, n√£o repita conceitos recentes\n3. **Tema \"Expressar\"**: Trabalhe de forma sutil, n√£o repetitiva\n4. **Continuidade**: Mantenha coer√™ncia com a jornada espiritual\n5. **Originalidade**: Cada devocional deve trazer nova revela√ß√£o\n6. **Vers√£o B√≠blica**: Sempre ACF (Almeida Corrigida Fiel)\n7. **Tamanho**: M√°ximo 4000 caracteres (WhatsApp permite 4096)\n8. **Assinatura**: Apenas \"Alex e Daniela Mantovani\" (sem t√≠tulos)\n\n## FORMATO DE SA√çDA (JSON):\n\nRetorne APENAS um objeto JSON v√°lido, SEM markdown code blocks:\n\n{\n  \"text\": \"[texto completo formatado para WhatsApp, SEM sauda√ß√£o personalizada. Comece direto com a data formatada: üìÖ ...]\",\n  \"title\": \"[t√≠tulo sem emoji]\",\n  \"date\": \"{{ $now.setZone('America/Sao_Paulo').toFormat('yyyy-MM-dd') }}\",\n  \"versiculo_principal\": {\n    \"texto\": \"[texto completo do vers√≠culo]\",\n    \"referencia\": \"[refer√™ncia b√≠blica] ACF\"\n  },\n  \"versiculo_apoio\": {\n    \"texto\": \"[texto completo do vers√≠culo]\",\n    \"referencia\": \"[refer√™ncia b√≠blica] ACF\"\n  },\n  \"metadata\": {\n    \"autor\": \"Alex e Daniela Mantovani\",\n    \"tema\": \"[tema/conceito trabalhado]\",\n    \"conceito_central\": \"[conceito espec√≠fico do dia]\",\n    \"palavras_chave\": [\"palavra1\", \"palavra2\", \"palavra3\"],\n    \"relacionado_expressar\": \"[como se relaciona com Expressar]\"\n  }\n}\n\nIMPORTANTE: Retorne APENAS o JSON, sem markdown code blocks (```json), sem texto adicional antes ou depois.\n```\n\n## üîß Configura√ß√£o no n8n\n\n**N√≥: OpenAI / LangChain**\n\n- **Model**: `gpt-4` ou `gpt-3.5-turbo`\n- **Temperature**: `0.8`\n- **Max Tokens**: `2000`\n\n**Nota sobre vari√°veis:**\n- Se usar an√°lise intermedi√°ria: `$('Analisar Hist√≥rico').item.json`\n- Se pular an√°lise: `$('Buscar Contexto').item.json`\n\n---\n\n**Use este prompt no n√≥ de gera√ß√£o!** ‚úçÔ∏è",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        1056,
        -128
      ],
      "id": "15fde618-a107-42a0-98de-f855a49bb3b5",
      "name": "Gerar Devocional"
    },
    {
      "parameters": {
        "jsCode": "const output = $input.item.json.output;\n\n// Buscar o JSON dentro da string (procura por { ... })\nconst jsonMatch = output.match(/\\{[\\s\\S]*\\}/);\n\nif (!jsonMatch) {\n  throw new Error('JSON n√£o encontrado na string');\n}\n\n// Parse do JSON encontrado\nconst devocional = JSON.parse(jsonMatch[0]);\n\nreturn devocional;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        -128
      ],
      "id": "e7661801-c469-4b41-9190-051b6094cdc3",
      "name": "Extrair JSON"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://imobmiq-devocional.90qhxz.easypanel.host/api/devocional/webhook",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-Webhook-Secret",
              "value": "Fs142779"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1616,
        -128
      ],
      "id": "73db4ac8-69e6-42a1-af30-4a10498cecef",
      "name": "Enviar Webhook"
    },
    {
      "parameters": {
        "jsCode": "// Extrair JSON do output da IA\nlet output = $input.item.json;\n\n// Se tiver estrutura \"output\" ou \"output parser\"\nif (output.output) {\n  output = output.output;\n}\n\n// Se for string, tentar fazer parse\nif (typeof output === 'string') {\n  // Remover prefixos comuns\n  let jsonString = output\n    .replace(/^output\\s*:\\s*/i, '')\n    .replace(/^json\\n?/i, '')\n    .trim();\n  \n  // Remover markdown code blocks se existirem\n  jsonString = jsonString\n    .replace(/^```json\\n?/gi, '')\n    .replace(/^```\\n?/g, '')\n    .replace(/```\\n?$/g, '')\n    .trim();\n  \n  // Buscar JSON dentro da string (procura por { ... })\n  const jsonMatch = jsonString.match(/\\{[\\s\\S]*\\}/);\n  \n  if (jsonMatch) {\n    try {\n      output = JSON.parse(jsonMatch[0]);\n    } catch (e) {\n      throw new Error(`Erro ao fazer parse do JSON: ${e.message}`);\n    }\n  } else {\n    throw new Error('JSON n√£o encontrado na string');\n  }\n}\n\n// Verificar se tem a estrutura esperada\nif (!output.text && !output.title) {\n  // Tentar encontrar em sub-objetos\n  if (output.data) {\n    output = output.data;\n  } else if (output.result) {\n    output = output.result;\n  } else if (output.content) {\n    output = output.content;\n  }\n}\n\n// Retornar o objeto limpo\nreturn {\n  json: output\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        864,
        -128
      ],
      "id": "38f50475-2542-42dc-ad21-71dbfadfcc94",
      "name": "Formata Saida"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        992,
        96
      ],
      "id": "731e6d63-9b53-4012-9464-82bebb31ca27",
      "name": "Gemini Criador",
      "credentials": {
        "googlePalmApi": {
          "id": "aySuiq5yavDaRHby",
          "name": "Devocional"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Busca Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data": {
      "ai_tool": [
        [
          {
            "node": "Gerar Devocional",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Busca Contexto": {
      "main": [
        [
          {
            "node": "Analisar Hist√≥rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Analista": {
      "ai_languageModel": [
        [
          {
            "node": "Analisar Hist√≥rico",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Analisar Hist√≥rico": {
      "main": [
        [
          {
            "node": "Formata Saida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar Devocional": {
      "main": [
        [
          {
            "node": "Extrair JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair JSON": {
      "main": [
        [
          {
            "node": "Enviar Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formata Saida": {
      "main": [
        [
          {
            "node": "Gerar Devocional",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Criador": {
      "ai_languageModel": [
        [
          {
            "node": "Gerar Devocional",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4f9a7057-0682-44a7-8797-a1038068696e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f8cd840289dc44c3d827f2addf0c554765cb2bcf76dab1c5879f9cbf18361b8a"
  },
  "id": "jbFrpIKOYnmqH5X6",
  "tags": []
}